/*!
 * WP Media Picker - version 0.7.2
 * 
 * Felix Arntz <felix-arntz@leaves-and-love.net>
 */
!function(a,r,o){var e,t,i;if(void 0===r||void 0===r.media)return a.fn.wpMediaPicker=function(){return this},console.error("WP Media not found");e=r.media.view.MediaFrame.Select,t=e.extend({initialize:function(){o.defaults(this.options,{query:{},multiple:!1,editable:!0,filterable:"all",searchable:!0,displaySettings:!1,displayUserSettings:!1,editing:!1,state:"insert",metadata:{}}),e.prototype.initialize.apply(this,arguments)},createStates:function(){this.states.add([new r.media.controller.Library({id:"insert",title:this.options.title,selection:this.options.selection,priority:20,toolbar:"main-insert",filterable:this.options.filterable,searchable:this.options.searchable,library:r.media.query(this.options.query),multiple:this.options.multiple,editable:this.options.editable,displaySettings:this.options.displaySettings,displayUserSettings:this.options.displayUserSettings}),new r.media.controller.EditImage({model:this.options.editImage})])},bindHandlers:function(){e.prototype.bindHandlers.apply(this,arguments),this.on("toolbar:create:main-insert",this.createToolbar,this),this.on("content:render:edit-image",this.renderEditImageContent,this),this.on("toolbar:render:main-insert",this.renderMainInsertToolbar,this)},renderEditImageContent:function(){var e=new r.media.view.EditImage({controller:this,model:this.state().get("image")}).render();this.content.set(e),e.loadEditor()},renderMainInsertToolbar:function(e){var t=this;e.set("insert",{style:"primary",priority:80,text:t.options.buttonText,requires:{selection:!0},click:function(){t.close(),t.state().trigger("insert",t.state().get("selection")).reset()}})}}),i={options:{store:"id",query:{},multiple:!1,filterable:"all",searchable:!0,editable:!1,displaySettings:!1,displayUserSettings:!1,change:!1,clear:!1,label_add:r.media.view.l10n.addMedia,label_replace:r.media.view.l10n.replace,label_remove:r.media.view.l10n.remove,label_modal:r.media.view.l10n.addMedia,label_button:r.media.view.l10n.addMedia},_create:function(){var e=this;a.extend(e.options,e.element.data()),e.options.query&&e.options.query.post_mime_type&&(e.options.query.type=e.options.query.post_mime_type,delete e.options.query.post_mime_type),e._content_id="wp-mediapicker-content-"+e.element.attr("id"),e.element.hide().wrap('<div class="wp-mediapicker-container" />'),e._wrap=e.element.parent(),e._open_button=a('<button type="button" class="wp-mediapicker-open-button button" />').insertAfter(e.element),e._remove_button=a('<button type="button" class="wp-mediapicker-remove-button button-link button-link-delete" />').hide().insertAfter(e._open_button).text(e.options.label_remove),e._content_wrap=a('<div class="wp-mediapicker-content-wrap" />').insertAfter(e._remove_button),e._content=a('<div class="wp-mediapicker-content" />').appendTo(e._content_wrap).attr("id",e._content_id),e._frame=new t({title:e.options.label_modal,buttonText:e.options.label_button,frame:"select",state:"insert",selection:new r.media.model.Selection([],{multiple:e.options.multiple}),query:e.options.query,multiple:e.options.multiple,filterable:e.options.filterable,searchable:e.options.searchable,editable:e.options.editable}),e._setValue(e.element.val()),e._addListeners()},_addListeners:function(){var n=this;n._frame.on("insert",function(){var e=n._frame.state().get("selection"),t=e.models.map(function(e){return o.extend({},e.toJSON())}),i=o.extend({},e.first().toJSON());n._setAttachment(i),a(document).trigger("wpMediaPicker.insert",[t,n])}),n._open_button.on("click",function(){n._frame.state("insert").get("selection").reset(n._attachment?[n._attachment]:[]),n.open()}),n._remove_button.on("click",function(){n._setAttachment(null)})},_createContent:function(e){var t=this;t._attachment=e,t._open_button.text(t.options.label_replace),t._remove_button.show();var i="";if("video"===e.type){var n="";e.image&&e.image.src!==e.icon&&(n=e.image.src),i+='<video class="wp-video-shortcode" preload="metadata"'+(n?' poster="'+n+'"':"")+' controls><source type="'+e.mime+'" src="'+e.url+'" /></video>'}else if("audio"===e.type)e.image&&e.image.src&&e.image.src!==e.icon?i+='<img class="wp-audio-cover" src="'+e.image.src+'" alt="'+e.filename+'" />':i+='<div class="mime-type-icon"><img src="'+e.icon+'" /><span>'+e.filename+"</span></div>",i+='<audio class="wp-audio-shortcode" width="100%" preload="none" controls><source type="'+e.mime+'" src="'+e.url+'" /></audio>';else{var a="image"===e.type?e.url:void 0;e.sizes&&(e.sizes.large?a=e.sizes.large.url:e.sizes.full&&(a=e.sizes.full.url)),i+=a?'<img src="'+a+'" alt="'+e.alt+'" />':'<div class="mime-type-icon"><img src="'+e.icon+'" /><span>'+e.filename+"</span></div>"}0<=i.search("<img ")?t._content.addClass("size-auto"):t._content.removeClass("size-auto"),t._content.show().html(i)},_resetContent:function(){var e=this;e._attachment=null,e._open_button.text(e.options.label_add),e._remove_button.hide(),e._content.hide().empty().removeClass("size-auto")},_getAttachment:function(){return this._attachment},_setAttachment:function(e){var t=e&&this._attachment&&e.id===this._attachment.id||!e&&!this._attachment;if(!e){if(this._resetContent(),t)return;return this.element.val(null),this.element.trigger("change"),"function"==typeof this.options.clear&&this.options.clear.call(this),void a(document).trigger("wpMediaPicker.updateField",[null,this])}this._createContent(e),t||("url"===this.options.store?this.element.val(e.url):this.element.val(e.id),this.element.trigger("change"),"function"==typeof this.options.change&&this.options.change.call(this),a(document).trigger("wpMediaPicker.updateField",[e,this]))},_getValue:function(){return this._attachment?"url"===this.options.store?this._attachment.url:this._attachment.id:""},_setValue:function(e){var t,i,n,a,o,s=this;t=e,i=s.options.store,n=function(e){s._setAttachment(e)},a=function(){s._setAttachment(null)},t?(o="url"===i?{action:"get-attachment-by-url",url:t}:{action:"get-attachment",id:parseInt(t,10)},r.media.ajax({type:"POST",data:o,success:n,error:a})):a()},open:function(){r.media.frame=this._frame,this._frame.open(),this._frame.$el.find(".media-frame-menu .media-menu-item.active").focus()},close:function(){this._frame.close()},attachment:function(e){if(void 0===e)return this._getAttachment();this._setAttachment(e)},value:function(e){if(void 0===e)return this._getValue();this._setValue(e)},frame:function(){return this._frame}},a.widget("wp.wpMediaPicker",i)}(jQuery,wp,_);